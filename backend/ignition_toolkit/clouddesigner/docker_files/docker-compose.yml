# docker-compose.yml
# CloudDesigner - Browser-Accessible Ignition Designer

services:
  nginx:
    image: nginx:alpine
    container_name: clouddesigner-nginx
    restart: unless-stopped
    depends_on:
      guacamole:
        condition: service_healthy
    ports:
      - "${GUACAMOLE_PORT:-8080}:80"
    networks:
      clouddesigner-net:
        ipv4_address: 10.100.0.5
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/context.html:/usr/share/nginx/html/context.html:ro
      - ./nginx/auto-login.html:/usr/share/nginx/html/auto-login.html:ro

  guacd:
    image: guacamole/guacd:1.5.4
    container_name: clouddesigner-guacd
    restart: unless-stopped
    networks:
      clouddesigner-net:
        ipv4_address: 10.100.0.2
    volumes:
      - guacd-drive:/drive
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4822"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s  # Give guacd time to start

  guacamole:
    image: guacamole/guacamole:1.5.4
    container_name: clouddesigner-guacamole
    restart: unless-stopped
    depends_on:
      guacd:
        condition: service_healthy
    environment:
      GUACD_HOSTNAME: guacd
      GUACD_PORT: 4822
      GUACAMOLE_HOME: /etc/guacamole
    networks:
      clouddesigner-net:
        ipv4_address: 10.100.0.3
    user: root
    volumes:
      - ./guacamole/guacamole.properties:/etc/guacamole/guacamole.properties
      - ./guacamole/user-mapping.xml:/etc/guacamole/user-mapping.xml
      - ./guacamole/extensions:/etc/guacamole/extensions
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/guacamole/"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s  # Give Tomcat/Guacamole time to initialize

  designer-desktop:
    image: clouddesigner-desktop:latest
    build:
      context: ./designer-desktop
      args:
        - UBUNTU_VERSION=24.04
        - JAVA_VERSION=17
        - IGNITION_GATEWAY_URL=${IGNITION_GATEWAY_URL:-}
    container_name: clouddesigner-desktop
    restart: unless-stopped
    environment:
      - VNC_RESOLUTION=${VNC_RESOLUTION:-1920x1080}
      - VNC_DEPTH=${VNC_DEPTH:-24}
      - VNC_PASSWORD=${VNC_PASSWORD:-designer}
      - IGNITION_GATEWAY_URL=${IGNITION_GATEWAY_URL:-}
      - IGNITION_USERNAME=${IGNITION_USERNAME:-}
      - IGNITION_PASSWORD=${IGNITION_PASSWORD:-}
      - DESIGNER_MEMORY=${DESIGNER_MEMORY:-2048}
      - TZ=${TIMEZONE:-Australia/Adelaide}
    networks:
      clouddesigner-net:
        ipv4_address: 10.100.0.4
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - designer-home:/home/designer
      - shared-workspace:/workspace
    shm_size: '2gb'
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "5901"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s  # Give VNC server time to start

networks:
  clouddesigner-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.0.0/24

volumes:
  designer-home:
  shared-workspace:
  guacd-drive:
