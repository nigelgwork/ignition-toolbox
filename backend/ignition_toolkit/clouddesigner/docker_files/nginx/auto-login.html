<!DOCTYPE html>
<html>
<head>
    <title>CloudDesigner - Connecting...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #1a1a2e;
            color: #eee;
        }
        .loader { text-align: center; }
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status { margin-top: 10px; font-size: 14px; color: #888; }
        .error { color: #ff6b6b; }
        a { color: #00d4ff; }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p>Connecting to Ignition Designer...</p>
        <p class="status" id="status"></p>
    </div>
    <script>
        const status = document.getElementById('status');

        async function autoLogin() {
            try {
                status.textContent = 'Authenticating...';

                const response = await fetch('/api/tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=designer&password=designer'
                });

                if (!response.ok) throw new Error('Authentication failed');

                const data = await response.json();
                const token = data.authToken;

                status.textContent = 'Loading connections...';

                const connResponse = await fetch('/api/session/data/default/connections', {
                    headers: { 'Guacamole-Token': token }
                });

                if (!connResponse.ok) throw new Error('Failed to load connections');

                const connections = await connResponse.json();
                const connId = Object.keys(connections)[0];

                if (!connId) throw new Error('No connections configured');

                status.textContent = 'Login successful! Redirecting...';

                // Store auth token for Guacamole app
                sessionStorage.setItem('GUAC_AUTH_TOKEN', token);
                localStorage.setItem('GUAC_AUTH_TOKEN', token);

                // Redirect to home - user clicks connection once
                window.location.href = '/#/?token=' + token;

            } catch (e) {
                console.error(e);
                status.innerHTML = '<span class="error">Error: ' + e.message + '</span><br><br>' +
                    '<a href="/">Click here to login manually</a><br>' +
                    '<small>(Username: designer, Password: designer)</small>';
                document.querySelector('.spinner').style.display = 'none';
            }
        }

        autoLogin();
    </script>
</body>
</html>
