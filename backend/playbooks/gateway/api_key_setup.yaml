name: "Gateway API Key Setup"
version: "1.0"
description: "Create an Ignition 8.3 API key and store it in the Toolbox API Explorer"
domain: gateway
group: "Gateway (Base Playbooks)"
verified: true

parameters:
  - name: gateway_url
    type: string
    required: true
    default: "http://localhost:8088"
    description: "Gateway URL (e.g., http://localhost:8088)"

  - name: username
    type: string
    required: true
    description: "Gateway admin username"

  - name: password
    type: string
    required: true
    description: "Gateway admin password"

  - name: api_key_name
    type: string
    required: false
    default: "toolbox-api-key"
    description: "Name for the API key in both Ignition and Toolbox"

steps:
  - id: step1
    name: "Step 1: Login to Gateway"
    type: playbook.run
    parameters:
      playbook: "gateway/gateway_login.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"
    on_failure: abort

  - id: step2
    name: "Step 2: Navigate to API Keys Page"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}/app/platform/security/api-keys"
    timeout: 15
    on_failure: abort

  - id: step3
    name: "Step 3: Wait for API Keys Page"
    type: browser.wait
    parameters:
      selector: "h1, h2, [class*='api-key'], [class*='apiKey'], .ia_heading"
      timeout: 10000
    timeout: 15

  - id: step4
    name: "Step 4: Screenshot API Keys Page"
    type: browser.screenshot
    parameters:
      path: "api_keys_page.png"
    on_failure: continue

  - id: step5
    name: "Step 5: Click Create Button"
    type: browser.click
    parameters:
      selector: "button:has-text('Create'), button:has-text('Add'), a:has-text('Create'), a:has-text('Add')"
      timeout: 10000
    on_failure: abort

  - id: step6
    name: "Step 6: Wait for Creation Form"
    type: browser.wait
    parameters:
      selector: "input[name='name'], input[name='tokenName'], input[type='text'], .modal input, dialog input"
      timeout: 10000
    timeout: 15

  - id: step7
    name: "Step 7: Enter Token Name"
    type: browser.fill
    parameters:
      selector: "input[name='name'], input[name='tokenName'], input[type='text'], .modal input, dialog input"
      value: "{{ parameter.api_key_name }}"
      timeout: 10000

  - id: step8
    name: "Step 8: Screenshot Filled Form"
    type: browser.screenshot
    parameters:
      path: "api_key_form_filled.png"
    on_failure: continue

  - id: step9
    name: "Step 9: Submit Creation"
    type: browser.click
    parameters:
      selector: "button:has-text('Save'), button:has-text('Create'), button:has-text('Submit'), button[type='submit']"
      timeout: 10000
    on_failure: abort

  - id: step10
    name: "Step 10: Wait for Token Display"
    type: browser.wait
    parameters:
      selector: "code, pre, .token-display, [class*='token'], [class*='secret'], .ia_inputField input[readonly], textarea[readonly]"
      timeout: 15000
    timeout: 20
    on_failure: abort

  - id: step11
    name: "Step 11: Screenshot Token Display"
    type: browser.screenshot
    parameters:
      path: "api_key_token_displayed.png"
    on_failure: continue

  - id: step12
    name: "Step 12: Extract Token Value"
    type: browser.get_text
    parameters:
      selector: "code, pre, .token-display, [class*='token'], [class*='secret'], .ia_inputField input[readonly], textarea[readonly]"
      timeout: 10000
    on_failure: abort

  - id: step13
    name: "Step 13: Store Token in Toolbox"
    type: utility.python
    parameters:
      script: |
        r"""
        Store the extracted API key in the Toolbox API Explorer credentials.
        Token: {{ step.step12.text }}
        Gateway: {{ parameter.gateway_url }}
        Name: {{ parameter.api_key_name }}
        """
        from ignition_toolkit.api.services.api_key_service import APIKeyService

        token = r"""{{ step.step12.text }}""".strip()
        gateway_url = r"""{{ parameter.gateway_url }}""".strip()
        key_name = r"""{{ parameter.api_key_name }}""".strip()

        service = APIKeyService()
        try:
            service.create_api_key(
                name=key_name,
                gateway_url=gateway_url,
                api_key=token,
                description="Created by API Key Setup playbook",
            )
            result = f"Created API key '{key_name}' for {gateway_url}"
        except ValueError:
            service.update_api_key(
                name=key_name,
                gateway_url=gateway_url,
                api_key=token,
                description="Updated by API Key Setup playbook",
            )
            result = f"Updated existing API key '{key_name}' for {gateway_url}"

        print(result)
    on_failure: abort

  - id: step14
    name: "Step 14: Final Screenshot"
    type: browser.screenshot
    parameters:
      path: "api_key_setup_complete.png"
    on_failure: continue

  - id: step15
    name: "Step 15: Log Success"
    type: utility.log
    parameters:
      message: "API key '{{ parameter.api_key_name }}' has been created in the Ignition Gateway and stored in the Toolbox API Explorer. You can now use it in the API Explorer tab."
      level: "info"
