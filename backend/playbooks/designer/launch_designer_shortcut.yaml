name: "Launch Designer via Shortcut"
version: "1.0"
description: "Launch Ignition Designer application"
domain: designer

parameters:
  - name: designer_shortcut
    type: string
    required: true
    description: "Full Designer launcher shortcut command"

  - name: project_name
    type: string
    required: true
    description: "Name of the Designer project to open"

  - name: gateway_credential
    type: credential
    required: true
    description: "Gateway credential to use for Designer login"

steps:
  # Step 1: Launch Designer and wait for login window
  - id: launch_designer
    name: "Step 1: Launch Designer and wait for login window"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import asyncio
        import time

        designer_shortcut = r"""{{ designer_shortcut }}"""

        print(f"[1/3] Launching Ignition Designer...")

        # Parse shortcut to extract executable and arguments
        parts = designer_shortcut.split(" -D", 1)
        designer_exe = parts[0].strip().strip('"')

        if len(parts) > 1:
            args = "-D" + parts[1]
            launch_cmd = f'powershell.exe -Command "Start-Process \\"{designer_exe}\\" -ArgumentList \\"{args}\\""'
        else:
            launch_cmd = f'powershell.exe -Command "Start-Process \\"{designer_exe}\\""'

        # Launch Designer
        proc = subprocess.Popen(launch_cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        proc.wait()

        print("Waiting for login window...")
        max_attempts = 6
        attempt = 0
        login_window = False

        while attempt < max_attempts:
            # Use list form to avoid shell expansion of $_ variable
            check_cmd = [
                "powershell.exe",
                "-Command",
                "Get-Process | Where-Object {$_.MainWindowTitle -eq 'Login - Ignition'} | Measure-Object | Select-Object -ExpandProperty Count"
            ]
            result = subprocess.run(check_cmd, capture_output=True, text=True)
            count = result.stdout.strip()

            if count and count != "0":
                print("✓ Login window detected!")
                login_window = True
                break

            attempt += 1
            if attempt < max_attempts:
                print(f"  Checking... (attempt {attempt}/{max_attempts})")
                time.sleep(5)

        if not login_window:
            raise Exception("Login window did not appear after 30 seconds")

        # Wait for UI to fully initialize (Java Swing needs time after window appears)
        print("Allowing login window to fully initialize...")
        time.sleep(2)

        print("LOGIN_WINDOW_READY=true")
    timeout: 60
    on_failure: abort

  # Step 2: Enter credentials and login
  - id: login
    name: "Step 2: Enter credentials and login"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import os

        username = r"""{{ parameter.gateway_credential.username }}"""
        password = r"""{{ parameter.gateway_credential.password }}"""

        print(f"[2/3] Entering credentials for user: {username}")

        # Get path to PowerShell login script
        script_dir = "/git/ignition-playground/ignition_toolkit/designer/scripts"
        login_script = os.path.join(script_dir, "enter-designer-login.ps1")

        # Execute PowerShell script to enter credentials
        login_cmd = f'powershell.exe -ExecutionPolicy Bypass -File "{login_script}" -Username "{username}" -Password "{password}"'
        result = subprocess.run(login_cmd, shell=True, capture_output=True, text=True)
        output = result.stdout.strip().split('\n')[-1].strip()

        if output != "success":
            raise Exception(f"Failed to enter credentials. Result: {output}")

        print("✓ Credentials entered successfully")

        # Wait for project selection screen
        print("Waiting for project selection...")
        import time
        max_attempts = 5
        attempt = 0
        project_window = False

        while attempt < max_attempts:
            # Use list form to avoid shell expansion of $_ variable
            check_cmd = [
                "powershell.exe",
                "-Command",
                "Get-Process | Where-Object {$_.MainWindowTitle -like '*Open/Create Project*'} | Measure-Object | Select-Object -ExpandProperty Count"
            ]
            result = subprocess.run(check_cmd, capture_output=True, text=True)
            count = result.stdout.strip()

            if count and count != "0":
                print("✓ Project selection screen detected!")
                project_window = True
                break

            attempt += 1
            if attempt < max_attempts:
                print(f"  Checking... (attempt {attempt}/{max_attempts})")
                time.sleep(3)

        if not project_window:
            raise Exception("Project selection screen did not appear. Login may have failed.")

        print("PROJECT_SELECTION_READY=true")
    timeout: 60
    on_failure: abort

  # Step 3: Search and open project
  - id: open_project
    name: "Step 3: Search and open project"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import os
        import time

        project_name = r"""{{ project_name }}"""

        print(f"[3/3] Opening project '{project_name}'...")

        # Get path to PowerShell project opener script
        script_dir = "/git/ignition-playground/ignition_toolkit/designer/scripts"
        project_script = os.path.join(script_dir, "open-designer-project-mouse.ps1")

        # Execute PowerShell script to open project
        project_cmd = f'powershell.exe -ExecutionPolicy Bypass -File "{project_script}" -ProjectName "{project_name}"'
        result = subprocess.run(project_cmd, shell=True, capture_output=True, text=True)
        output = result.stdout.strip().split('\n')[-1].strip()

        if output != "success":
            raise Exception(f"Failed to open project. Result: {output}")

        print("")
        print("=" * 50)
        print("✓ Project opening initiated!")
        print("=" * 50)
        print(f"The project '{project_name}' should now be opening in Designer.")

        # Wait and verify project opened
        time.sleep(5)
        # Use list form to avoid shell expansion of $_ variable
        verify_cmd = [
            "powershell.exe",
            "-Command",
            "Get-Process | Where-Object {($_.ProcessName -eq 'java') -or ($_.ProcessName -eq 'javaw')} | Select-Object -ExpandProperty MainWindowTitle"
        ]
        result = subprocess.run(verify_cmd, capture_output=True, text=True)
        window_titles = result.stdout

        if project_name.lower() in window_titles.lower():
            print(f"✓ CONFIRMED: Project '{project_name}' is now open!")
        else:
            print("⚠ Could not verify project opened. Please check the Designer window.")

        print("PROJECT_OPENED=true")
    timeout: 60
    on_failure: abort
