name: "Launch Designer via Shortcut (Linux)"
version: "1.0"
description: "Launch Ignition Designer application on Linux using xdotool and X11 automation"
domain: designer

parameters:
  - name: designer_command
    type: string
    required: true
    description: "Full Designer launcher command (e.g., /usr/local/bin/ignition-designer)"

  - name: project_name
    type: string
    required: true
    description: "Name of the Designer project to open"

  - name: gateway_credential
    type: credential
    required: true
    description: "Gateway credential to use for Designer login"

steps:
  # Step 1: Launch Designer and wait for login window
  - id: launch_designer
    name: "Step 1: Launch Designer and wait for login window"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import asyncio
        import time
        import sys
        import os

        # Add parent directory to path to import designer module
        sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

        from ignition_toolkit.designer.platform_linux import LinuxDesignerAutomation

        designer_command = r"""{{ designer_command }}"""

        print(f"[1/3] Launching Ignition Designer on Linux...")
        print(f"Command: {designer_command}")

        # Launch Designer in background
        try:
            proc = subprocess.Popen(
                designer_command,
                shell=True,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                start_new_session=True  # Detach from parent
            )
            print(f"✓ Designer process started (PID: {proc.pid})")
        except Exception as e:
            raise Exception(f"Failed to launch Designer: {e}")

        # Wait a moment for process to start
        time.sleep(3)

        # Initialize Linux automation
        automation = LinuxDesignerAutomation()

        print("Waiting for login dialog...")
        max_attempts = 12
        attempt = 0
        login_found = False

        while attempt < max_attempts:
            # Look for login dialog
            if automation.find_login_dialog(timeout=5):
                print("✓ Login dialog detected!")
                login_found = True
                break

            attempt += 1
            if attempt < max_attempts:
                print(f"  Searching... (attempt {attempt}/{max_attempts})")
                time.sleep(2)

        if not login_found:
            raise Exception("Login dialog did not appear after 60 seconds")

        # Wait for UI to fully initialize
        print("Allowing login dialog to fully initialize...")
        time.sleep(2)

        print("LOGIN_WINDOW_READY=true")
    timeout: 90
    on_failure: abort

  # Step 2: Enter credentials and login
  - id: login
    name: "Step 2: Enter credentials and login"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import os
        import sys
        import time

        # Add parent directory to path
        sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

        from ignition_toolkit.designer.platform_linux import LinuxDesignerAutomation

        username = r"""{{ parameter.gateway_credential.username }}"""
        password = r"""{{ parameter.gateway_credential.password }}"""

        print(f"[2/3] Entering credentials for user: {username}")

        # Initialize automation
        automation = LinuxDesignerAutomation()

        # Re-find the login dialog to ensure we have the correct window
        if not automation.find_login_dialog(timeout=5):
            raise Exception("Could not find login dialog")

        # Fill credentials using xdotool
        if not automation.fill_login_credentials(username, password):
            raise Exception("Failed to enter credentials")

        print("✓ Credentials entered successfully")

        # Wait for login to complete
        print("Waiting for login to complete...")
        if not automation.wait_for_login_completion(timeout=30):
            raise Exception("Login did not complete successfully")

        print("✓ Login successful!")

        # Wait for project selection screen
        print("Waiting for project selection...")
        if not automation.find_project_selector(timeout=15):
            raise Exception("Project selection screen did not appear")

        print("✓ Project selection screen ready")
        print("PROJECT_SELECTION_READY=true")
    timeout: 60
    on_failure: abort

  # Step 3: Search and open project
  - id: open_project
    name: "Step 3: Search and open project"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import os
        import sys
        import time

        # Add parent directory to path
        sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

        from ignition_toolkit.designer.platform_linux import LinuxDesignerAutomation

        project_name = r"""{{ project_name }}"""

        print(f"[3/3] Opening project '{project_name}'...")

        # Initialize automation
        automation = LinuxDesignerAutomation()

        # Re-find the Designer window
        if not automation.find_designer_window(timeout=5):
            raise Exception("Could not find Designer window")

        # Select project using xdotool
        if not automation.select_project(project_name, timeout=10):
            raise Exception(f"Failed to open project '{project_name}'")

        print("")
        print("=" * 50)
        print("✓ Project opening initiated!")
        print("=" * 50)
        print(f"The project '{project_name}' should now be opening in Designer.")

        # Wait for project to load
        time.sleep(5)

        # Verify project opened by checking window title
        if automation.find_designer_window(timeout=10):
            print(f"✓ CONFIRMED: Designer is running with project!")
        else:
            print("⚠ Could not verify project opened. Please check the Designer window.")

        print("PROJECT_OPENED=true")
    timeout: 60
    on_failure: abort
